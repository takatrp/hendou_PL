<!DOCTYPE html>
<!-- internal version: r58 (toggle graph: ball <-> CVP) -->
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no" />
<title>ボールで学ぶ変動損益計算書</title>
<style>
:root{--brand:#578899;--brand-600:#4b7481;--ink:#0f172a;--line:#e5e7eb;--line-dark:#cbd5e1;--danger:#b91c1c;--orange:#d39a2c}
*{box-sizing:border-box}
html,body{margin:0;height:100%;width:100%;position:fixed;inset:0;overflow:auto;overflow-x:hidden;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent;font:16px/1.6 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI","Yu Gothic",Meiryo,sans-serif;color:var(--ink);background:#fff}
.page{min-height:100%;padding:16px}
.stack{max-width:1120px;width:100%;margin:0 auto}
.grid-main{display:grid;gap:16px;grid-template-columns:1fr}
@media (min-width:960px){.grid-main{grid-template-columns:minmax(0,1.1fr) minmax(0,0.9fr)}}
@media (max-width:959.9px) and (orientation:landscape){.grid-main{grid-template-columns:1fr 1fr}}
.card{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 6px 16px rgba(0,0,0,.06);padding:12px;min-width:0}
h1{font-size:18px;margin:0 0 8px}
.note-top{background:#eef7fa;border:1px solid #d6e7ee;color:#0b3c4a;padding:6px 8px;border-radius:12px;margin:6px 0 10px;font-size:13px}
.mode-toggle{display:flex;gap:6px;margin-bottom:8px}
.mode-toggle button{flex:1 1 auto;appearance:none;border:1px solid var(--line-dark);background:#fff;padding:6px 8px;border-radius:999px;font-weight:700;cursor:pointer}
.mode-toggle button.active{background:var(--brand);color:#fff;border-color:var(--brand)}
canvas{display:block;height:auto;border:1px solid var(--line);border-radius:12px;background:#fff;margin:0 auto;max-width:calc(100vw - 32px)}
.btns{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
button.generic{appearance:none;border:0;border-radius:12px;padding:8px 12px;font-weight:700;cursor:pointer}
.primary{background:var(--brand);color:#fff}.primary:active{background:var(--brand-600)}
.secondary{background:#fff;color:#0f172a;border:1px solid var(--line-dark)}
.result{font-size:16px;font-weight:700;margin-top:4px}.result.ng{color:var(--danger)}
.controls{display:grid;gap:8px}
label.f{display:block;background:#fafafa;border:1px solid var(--line);border-radius:12px;padding:6px 8px}
.f .row1{display:flex;align-items:center;justify-content:space-between;gap:8px}
.f .row1 .ttl{font-weight:600;white-space:nowrap}
.f .row2{margin-top:6px}
input[type="text"],input[type="number"]{width:96px;max-width:38vw;background:#fff;border:1px solid var(--line-dark);border-radius:8px;padding:8px;text-align:right}
input[type="range"]{appearance:none;width:100%;height:28px;background:transparent}
input[type="range"]::-webkit-slider-runnable-track{height:8px;border-radius:999px;background:var(--line)}
input[type="range"]::-webkit-slider-thumb{appearance:none;width:20px;height:20px;border-radius:50%;background:var(--brand);border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,.2);margin-top:-6px}
.challenge{border:1px dashed var(--line-dark);padding:10px;border-radius:12px;background:#fbfdfe}
.guide{color:#334155;font-size:14px;font-weight:700;margin:2px 4px -2px}
.challenge .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:6px}
.metrics{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
.m{background:#fafafa;border:1px solid var(--line);border-radius:12px;padding:10px}
.m .k{color:#334155;font-size:12px}.m .v{font-weight:700;margin-top:4px}
.m.accent{background:#eef7fa;border-color:var(--brand);box-shadow:0 0 0 2px rgba(87,136,153,.35) inset, 0 4px 14px rgba(87,136,153,.18)}
#targetLabel,#targetShown{font-weight:700}
.calc-note{font-weight:700;color:var(--brand);background:#eef7fa;border:1px solid #d6e7ee;border-radius:8px;padding:6px 8px;margin-top:6px}
.footer{display:flex;justify-content:center;margin:12px 0 2px;color:#334155;font-size:12px}
@media (max-width:480px){h1{font-size:17px}.card{padding:10px}.note-top{font-size:12px}input[type="text"],input[type="number"]{width:86px;padding:7px}}
</style>
</head>
<body>
<div class="page">
  <div class="stack">
    <div class="grid-main">
      <div class="card" id="cardGraph">
        <h1>ボールで学ぶ変動損益計算書</h1>
        <div class="note-top">
          ・固定費：越えるべきハードルの高さ／・売上高：ボールを落とす高さ／・限界利益：バウンドした頂点<br>
          バウンド頂点（限界利益）がハードル（固定費）を越えれば黒字です。
        </div>

        <!-- グラフ表示モード切替 -->
        <div class="mode-toggle">
          <button id="modeBall" class="active" type="button">バウンド表示</button>
          <button id="modeCVP"  type="button">CVP図（一般形）</button>
        </div>

        <canvas id="cv" width="860" height="420" aria-label="学習キャンバス"></canvas>

        <div class="btns">
          <button id="play" class="primary generic" type="button">黒字かどうか確認</button>
          <button id="reset" class="secondary generic" type="button">リセット</button>
        </div>
        <div id="result" class="result" aria-live="polite"></div>
      </div>

      <div class="card" id="cardCtrl">
        <div class="controls" id="controls">
          <label class="f" id="paramSales"><div class="row1"><span class="ttl">売上高（S）</span>
            <input id="sales" type="text" inputmode="numeric" pattern="[0-9,]*" value="1,000,000"></div>
            <div class="row2"><input id="salesRange" type="range" min="0" max="5000000" step="1000" value="1000000"></div>
          </label>

          <label class="f" id="paramCMR"><div class="row1"><span class="ttl">限界利益率（CMR, %）</span>
            <input id="cmr" type="number" inputmode="decimal" min="0" max="100" step="0.1" value="60"></div>
            <div class="row2"><input id="cmrRange" type="range" min="0" max="100" step="0.1" value="60"></div>
          </label>

          <label class="f" id="paramFixed"><div class="row1"><span class="ttl">固定費（FC）</span>
            <input id="fixed" type="text" inputmode="numeric" pattern="[0-9,]*" value="700,000"></div>
            <div class="row2"><input id="fixedRange" type="range" min="0" max="2000000" step="1000" value="700000"></div>
          </label>

          <div class="challenge" id="challengeBox"><label><input type="checkbox" id="challengeToggle"> 必要売上高を考えてみましょう</label></div>

          <div id="guideFixed" class="guide" style="display:none;">① （追加の）固定費はいくらですか？</div>
          <div id="guideCMR" class="guide" style="display:none;">② 限界利益率は何％ですか？</div>
          <div id="guideSales" class="guide" style="display:none;">③ 上記を元に、必要売上高を考えてみましょう</div>

          <div class="challenge row" id="checkRow" style="display:none;">
            <button id="checkBtn" class="primary generic" type="button">答え合わせ</button>
            <button id="reset2" class="secondary generic" type="button">リセット</button>
          </div>

          <div id="checkResult" style="display:none;margin-top:6px">
            <div><span id="targetLabel">必要売上高（損益分岐点売上高）：</span><span id="targetShown">—</span></div>
            <div><span id="diffMsg">—</span> ／<span id="status">—</span></div>
            <div id="calcNote" class="calc-note">※必要売上高は、固定費÷限界利益率で逆算できます。</div>
          </div>

          <div id="warnCMR0" class="muted" style="display:none;color:#8b5e00">※ 限界利益率が0%のため、どれだけ売上高があっても黒字になりません。</div>
        </div>

        <div class="metrics" id="metrics">
          <div class="m"><div class="k">売上高 (S)</div><div id="mSales" class="v">-</div></div>
          <div class="m"><div class="k">限界利益率 (CMR)</div><div id="mCMR" class="v">-</div></div>
          <div class="m em"><div class="k">限界利益 (S×CMR)</div><div id="mCM" class="v">-</div></div>
          <div class="m" id="mBEPcard"><div class="k">損益分岐点売上高 (FC÷CMR)</div><div id="mBEP" class="v">-</div></div>
          <div class="m em"><div class="k">経常利益 ≒ 限界利益−固定費</div><div id="mProfit" class="v">-</div></div>
        </div>
      </div>
    </div>
    <div class="footer">
      <small>Copyright (c) 2025 税理士法人松本会計事務所 All Rights Reserved. / r58</small>
    </div>
  </div>
</div>

<script>
(function(){
  const VERSION='r58';
  const DEFAULTS={sales:1000000, cmr:60, fixed:700000};
  const $=id=>document.getElementById(id);

  const IS_IOS_MOBILE = /iPhone|iPod/i.test(navigator.userAgent)
     || (navigator.platform==='MacIntel' && navigator.maxTouchPoints>1 && window.innerWidth<820);

  const cv=$('cv'), ctx=cv.getContext('2d');
  let dpr=1, playing=false, apexMarkerY=null, revealedByPlay=false;
  let graphMode='ball'; // 'ball' | 'cvp'

  // 答え合わせ同期 & ライン/帯の表示制御（バウンド表示で利用）
  let pendingCheck=false, pendingVals=null;
  let showTargetLine=false, targetLineValue=null;
  let showMOSBand=false;

  const dims={W:360,H:240,MARGIN:36,GROUND_Y:204};
  const sy=(v,maxV)=>(dims.H - dims.MARGIN*2) * (v / maxV);
  const jpy=v=>isFinite(v)?v.toLocaleString('ja-JP',{style:'currency',currency:'JPY',maximumFractionDigits:0}):'—';
  const pct=(v)=>isFinite(v)?(Math.round(v*10)/10).toFixed(1)+'%':'—';
  const brand=()=>getComputedStyle(document.documentElement).getPropertyValue('--brand').trim()||'#578899';

  const I={ sales:$('sales'), cmr:$('cmr'), fixed:$('fixed'),
            salesRange:$('salesRange'), cmrRange:$('cmrRange'), fixedRange:$('fixedRange') };

  const resultEl=$('result');
  const toggle=$('challengeToggle'), metrics=$('metrics');
  const controls=$('controls'), challengeBox=$('challengeBox');
  const paramSales=$('paramSales'), paramCMR=$('paramCMR'), paramFixed=$('paramFixed');
  const guideFixed=$('guideFixed'), guideCMR=$('guideCMR'), guideSales=$('guideSales');
  const checkRow=$('checkRow'), checkBtn=$('checkBtn'), reset2=$('reset2'), checkResult=$('checkResult');
  const targetShown=$('targetShown'), statusEl=$('status'), diffMsgEl=$('diffMsg');
  const mBEPcard=$('mBEPcard');

  // mode buttons
  const modeBall=$('modeBall'), modeCVP=$('modeCVP');

  function computeDims(){
    const parentW = cv.parentElement.clientWidth || window.innerWidth;
    const vpW = window.innerWidth;
    const isMobile = vpW < 820;
    const isLandscape = vpW > window.innerHeight;
    const avail = Math.min(parentW, vpW - 32);
    const extraInset = isMobile ? 12 : 10;
    const w = Math.max(280, avail - extraInset*2);
    const ratio = isMobile ? (isLandscape ? 0.52 : 0.60) : 0.66;
    const h = Math.max(220, Math.round(w*ratio));
    dims.W=w; dims.H=h; dims.MARGIN=36; dims.GROUND_Y=h-36;
  }
  function setupCanvas(){
    dpr=Math.max(1,window.devicePixelRatio||1);
    cv.width=Math.round(dims.W*dpr); cv.height=Math.round(dims.H*dpr);
    cv.style.width=dims.W+'px'; cv.style.height=dims.H+'px';
    ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr);
  }

  const parseComma=v=>Number(String(v??'').replace(/[^\d.-]/g,'')||0);

  function calc(){
    const sales=Math.max(0,parseComma(I.sales.value));
    const cmrPct=Math.max(0,Math.min(100,Number(I.cmr.value||0)));
    const fixed=Math.max(0,parseComma(I.fixed.value));
    const cmr=cmrPct/100;
    const cm=sales*cmr;
    const profit=cm - fixed;
    const bep = cmr>0 ? Math.ceil(fixed/cmr) : Infinity;
    const vcr = Math.max(0, 1-cmr); // 変動費率（CVP図用）
    return {sales,cmrPct,cmr,cm,profit,bep,fixed,vcr};
  }

  function arrow(x1,y1,x2,y2,c){
    ctx.strokeStyle=c; ctx.fillStyle=c; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
    const a=Math.atan2(y2-y1,x2-x1),h=8;
    ctx.beginPath(); ctx.moveTo(x2,y2);
    ctx.lineTo(x2-h*Math.cos(a-Math.PI/6), y2-h*Math.sin(a-Math.PI/6));
    ctx.lineTo(x2-h*Math.cos(a+Math.PI/6), y2-h*Math.sin(a+Math.PI/6));
    ctx.closePath(); ctx.fill();
  }

  // ===== バウンド描画 =====
  function drawFixedBand(mt,maxV,xCMArrow){
    const BR=brand();
    const barL=dims.MARGIN, barR=dims.W-dims.MARGIN;
    const hH=sy(mt.fixed,maxV), y=dims.GROUND_Y-hH, hgt=Math.max(0,dims.GROUND_Y-y);
    if(IS_IOS_MOBILE){
      const startX=0, width=(barR-startX);
      ctx.fillStyle='rgba(87,136,153,0.22)';
      ctx.fillRect(startX,y,width,hgt);
      ctx.fillStyle=BR; ctx.fillText('固定費（ハードル）: '+jpy(mt.fixed), Math.max(6,dims.MARGIN-2), y-8);
    }else{
      const L=barL+40; const Rlimit=xCMArrow? (xCMArrow-30):(barR-40);
      const R=Math.max(L+24, Math.min(barR-40, Rlimit));
      const W=R-L;
      ctx.fillStyle='rgba(87,136,153,0.15)'; ctx.fillRect(L,y,W,hgt);
      ctx.strokeStyle=BR; ctx.lineWidth=2; ctx.strokeRect(L,y,W,hgt);
      ctx.fillStyle=BR; ctx.fillText('固定費（ハードル）: '+jpy(mt.fixed), Math.max(6,L), y-8);
    }
  }

  function drawBall(mt){
    const maxV=Math.max(1,mt.sales,mt.cm,mt.fixed, isFinite(targetLineValue)?targetLineValue:0)*1.15;
    const hide=toggle.checked && !revealedByPlay;

    ctx.clearRect(0,0,dims.W,dims.H);
    ctx.fillStyle='#fff'; ctx.fillRect(0,0,dims.W,dims.H);
    ctx.font='12px system-ui,-apple-system,Segoe UI,Roboto,sans-serif';

    // 地面
    ctx.fillStyle='#e2e8f0'; ctx.fillRect(0,dims.GROUND_Y,dims.W,3);

    // 目盛
    ctx.strokeStyle='#e5e7eb'; ctx.setLineDash([4,4]); ctx.lineWidth=1;
    ctx.fillStyle='#475569';
    for(let i=0;i<=5;i++){
      const val=(maxV/5)*i, h=sy(val,maxV), y=dims.GROUND_Y-h;
      ctx.beginPath(); ctx.moveTo(dims.MARGIN,y); ctx.lineTo(dims.W-dims.MARGIN,y); ctx.stroke();
      ctx.fillText(jpy(val), 6, y-2);
    }
    ctx.setLineDash([]);

    const xSalesArrow=dims.W-dims.MARGIN-18;
    const xCMArrow=xSalesArrow-28;

    // 固定費帯
    drawFixedBand(mt,maxV,xCMArrow);

    // 必要売上高ライン（答え合わせ後のみ）
    if(showTargetLine && isFinite(targetLineValue)){
      const yT=dims.GROUND_Y - sy(targetLineValue, maxV);
      ctx.save(); ctx.setLineDash([6,4]); ctx.strokeStyle='#0ea5e9';
      ctx.beginPath(); ctx.moveTo(dims.MARGIN,yT); ctx.lineTo(dims.W-dims.MARGIN-2,yT); ctx.stroke(); ctx.restore();
      ctx.fillStyle='#0ea5e9';
      ctx.fillText('必要売上高（損益分岐点売上高）: '+jpy(targetLineValue), Math.max(6,dims.MARGIN-2), yT-6);
    }

    // 売上
    const sH=sy(mt.sales,maxV), sY=dims.GROUND_Y-sH;
    ctx.save(); ctx.setLineDash([3,4]); ctx.strokeStyle='#475569';
    ctx.beginPath(); ctx.moveTo(dims.MARGIN,sY); ctx.lineTo(xSalesArrow-2,sY); ctx.stroke(); ctx.restore();
    const tSales='売上高: '+( (toggle.checked && !revealedByPlay) ? '???' : jpy(mt.sales) );
    ctx.save(); ctx.fillStyle='#475569'; ctx.textAlign= (toggle.checked && !revealedByPlay)?'right':'right';
    ctx.fillText(tSales, (toggle.checked && !revealedByPlay)?(xCMArrow-6):(dims.W-6), sY-6); ctx.restore();
    arrow(xSalesArrow, sY, xSalesArrow, dims.GROUND_Y-3, brand());

    // 限界利益
    const b=mt.cm, bH=sy(b,maxV), bY=dims.GROUND_Y-bH;
    if(!(toggle.checked && !revealedByPlay)){
      ctx.save(); ctx.setLineDash([3,4]); ctx.strokeStyle='#0ea5e9';
      ctx.beginPath(); ctx.moveTo(dims.MARGIN,bY); ctx.lineTo(xCMArrow-2,bY); ctx.stroke(); ctx.restore();
      ctx.fillStyle='#0ea5e9';
      const tCM='限界利益: '+jpy(b); const w=ctx.measureText(tCM).width;
      const xText=Math.min(dims.W-dims.MARGIN-w, xCMArrow+8);
      ctx.fillText(tCM, xText, bY-6);
      arrow(xCMArrow, dims.GROUND_Y-3, xCMArrow, bY, brand());
    }else{
      ctx.save(); ctx.fillStyle='#0ea5e9'; ctx.textAlign='right';
      ctx.fillText('限界利益: ???', xCMArrow-6, sY+16); ctx.restore();
    }

    // 安全余裕 帯（答え合わせ後）
    if(showMOSBand && showTargetLine && isFinite(targetLineValue)){
      const yS=sY, yB=dims.GROUND_Y - sy(targetLineValue, maxV);
      const yTop=Math.min(yS,yB), yBot=Math.max(yS,yB);
      const pos=(mt.sales - targetLineValue) >= 0;
      ctx.fillStyle= pos ? 'rgba(16,123,91,0.12)' : 'rgba(185,28,28,0.12)';
      ctx.fillRect(dims.MARGIN, yTop, (dims.W - dims.MARGIN*2), yBot - yTop);
    }

    // 待機ボール
    const rBall=(window.innerWidth<820)?8:9;
    if(!playing){
      const y0=dims.GROUND_Y-sH;
      ctx.beginPath(); ctx.fillStyle='#475569'; ctx.arc(dims.W/2,y0,rBall,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle='#94a3b8'; ctx.stroke();
    }

    // 残像
    if(apexMarkerY!=null){
      ctx.save(); ctx.globalAlpha=.5; ctx.strokeStyle='#94a3b8'; ctx.lineWidth=2;
      ctx.beginPath(); ctx.arc(dims.W/2,apexMarkerY,10,0,Math.PI*2); ctx.stroke(); ctx.restore();
    }

    // 両向き矢印（黒字/赤字）
    if(revealedByPlay){
      const bY2=bY, hY2=dims.GROUND_Y - sy(mt.fixed,maxV);
      const yTop=Math.min(bY2,hY2), yBot=Math.max(bY2,hY2);
      const xNear=Math.min(dims.W-dims.MARGIN-24,(dims.W/2)+((window.innerWidth<820)?8:9)+10);
      const p=mt.cm-mt.fixed; const color=p>0?brand():p<0?getComputedStyle(document.documentElement).getPropertyValue('--danger').trim()||'#b91c1c':'#334155';
      ctx.strokeStyle=color; ctx.fillStyle=color; ctx.lineWidth=2;
      ctx.beginPath(); ctx.moveTo(xNear,yTop); ctx.lineTo(xNear,yBot); ctx.stroke();
      const h=8;
      ctx.beginPath(); ctx.moveTo(xNear,yTop);
      ctx.lineTo(xNear-h*Math.cos(Math.PI/6), yTop+h*Math.sin(Math.PI/6));
      ctx.lineTo(xNear+h*Math.cos(Math.PI/6), yTop+h*Math.sin(Math.PI/6)); ctx.fill();
      ctx.beginPath(); ctx.moveTo(xNear,yBot);
      ctx.lineTo(xNear-h*Math.cos(Math.PI/6), yBot-h*Math.sin(Math.PI/6));
      ctx.lineTo(xNear+h*Math.cos(Math.PI/6), yBot-h*Math.sin(Math.PI/6)); ctx.fill();
      const txt=p>0?('黒字 '+jpy(p)):p<0?('赤字 '+jpy(-p)):'±0';
      ctx.save(); ctx.fillStyle=color; ctx.font='bold 12px system-ui,-apple-system,Segoe UI,Roboto,sans-serif'; ctx.textBaseline='middle';
      const wlbl=ctx.measureText(txt).width;
      ctx.fillText(txt, Math.min(dims.W-6-wlbl,xNear+10), (yTop+yBot)/2);
      ctx.restore();
    }
  }

  // ===== CVP図描画 =====
  function drawCVP(mt){
    // x: 売上高 (円), y: 費用・収益(円)
    const bep = mt.bep; const maxX = Math.max(mt.sales, isFinite(bep)?bep:0, mt.fixed*2) * 1.25;
    const maxY = Math.max(maxX, mt.fixed + mt.vcr*maxX) * 1.05;

    // 座標変換
    const L=dims.MARGIN, B=dims.GROUND_Y, R=dims.W-dims.MARGIN, T=dims.MARGIN;
    const xpix = x => L + (R-L) * (x/maxX);
    const ypix = y => B - (B-T) * (y/maxY);

    ctx.clearRect(0,0,dims.W,dims.H);
    ctx.fillStyle='#fff'; ctx.fillRect(0,0,dims.W,dims.H);
    ctx.font='12px system-ui,-apple-system,Segoe UI,Roboto,sans-serif';

    // 軸
    ctx.strokeStyle='#475569'; ctx.lineWidth=2;
    arrow(L,B, R+6, B, '#475569'); // x軸（売上高）
    arrow(L,B, L, T-6, '#475569'); // y軸（費用・収益）
    ctx.fillStyle='#475569';
    ctx.fillText('売上高', R-40, B+16);
    ctx.save(); ctx.translate(L-18, T+10); ctx.rotate(-Math.PI/2);
    ctx.fillText('費用・収益', 0,0); ctx.restore();

    // 目盛り（簡易）
    ctx.strokeStyle='#e5e7eb'; ctx.setLineDash([4,4]);
    for(let i=1;i<=4;i++){
      const y = ypix(maxY*i/5);
      ctx.beginPath(); ctx.moveTo(L,y); ctx.lineTo(R,y); ctx.stroke();
    }
    ctx.setLineDash([]);

    // 固定費の帯（全幅）
    ctx.fillStyle='rgba(87,136,153,0.18)';
    ctx.fillRect(L, ypix(mt.fixed), (R-L), ypix(0)-ypix(mt.fixed));
    ctx.fillStyle=brand();
    ctx.fillText('固定費', L+6, ypix(mt.fixed)-6);

    // 変動費の帯（固定費の上に、xに比例）
    ctx.fillStyle='rgba(211,154,44,0.18)';
    ctx.beginPath();
    ctx.moveTo(L, ypix(mt.fixed));
    ctx.lineTo(R, ypix(mt.fixed + mt.vcr*maxX));
    ctx.lineTo(R, ypix(mt.fixed));
    ctx.closePath(); ctx.fill();
    ctx.fillStyle='#a06f00';
    ctx.fillText('変動費', R-60, ypix(mt.fixed + mt.vcr*maxX)+14);

    // 売上高線（y=x）
    ctx.strokeStyle='#2a4b73'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(L, ypix(0)); ctx.lineTo(R, ypix(maxX)); ctx.stroke();
    ctx.fillStyle='#2a4b73'; ctx.fillText('売上高', R-50, ypix(maxX)-6);

    // 総費用線（固定費 + 変動費率×x）
    ctx.strokeStyle='var(--orange)'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(L, ypix(mt.fixed));
    ctx.lineTo(R, ypix(mt.fixed + mt.vcr*maxX)); ctx.stroke();
    ctx.fillStyle='var(--orange)'; ctx.fillText('費用', L+8, ypix(mt.fixed)+14);

    // 損益分岐点（交点）
    if(mt.cmr>0 && isFinite(bep)){
      const xb=xpix(bep), yb=ypix(bep); // y=bep on revenue line
      ctx.fillStyle='#2a4b73'; ctx.beginPath(); ctx.arc(xb,yb,5,0,Math.PI*2); ctx.fill();
      ctx.setLineDash([3,4]); ctx.strokeStyle='#64748b';
      ctx.beginPath(); ctx.moveTo(xb, yb); ctx.lineTo(xb, B); ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillStyle='#2a4b73'; ctx.fillText('損益分岐点', xb-30, yb-8);
      // 答え合わせで指定された「必要売上高」も同値なので、青で補足
      if(showTargetLine){ ctx.fillStyle='#0ea5e9'; ctx.fillText('必要売上高', xb-28, B+16); }
    }

    // 指定売上点での利益・損失（縦の差）
    const xS = Math.min(mt.sales, maxX);
    const ySales = xS; // 収益
    const yCost  = mt.fixed + mt.vcr*xS; // 総費用
    const ys=ypix(ySales), yc=ypix(yCost);
    const profit = ySales - yCost;
    const xMarker = xpix(xS);
    const yTop = Math.min(ys,yc), yBot=Math.max(ys,yc);
    const color = profit>=0?brand():getComputedStyle(document.documentElement).getPropertyValue('--danger').trim()||'#b91c1c';

    // 利益/損失の縦矢印
    ctx.strokeStyle=color; ctx.fillStyle=color; ctx.lineWidth=2;
    arrow(xMarker, yBot, xMarker, yTop, color);
    ctx.fillText((profit>=0?'利益':'損失'), xMarker+6, (yTop+yBot)/2);

    // 参考：現在売上の位置
    ctx.save(); ctx.setLineDash([4,4]); ctx.strokeStyle='#94a3b8';
    ctx.beginPath(); ctx.moveTo(xMarker, B); ctx.lineTo(xMarker, T+4); ctx.stroke(); ctx.restore();

    // ラベル（現在の売上高）
    ctx.fillStyle='#475569';
    ctx.textAlign='right'; ctx.fillText('売上高: '+jpy(mt.sales), Math.min(R,xMarker+120), ys-6);
    ctx.textAlign='start';
  }

  function renderMetrics(mt){
    $('mSales').textContent=jpy(mt.sales);
    $('mCMR').textContent=pct(mt.cmrPct);
    $('mCM').textContent=jpy(mt.cm);
    $('mBEP').textContent=isFinite(mt.bep)?jpy(mt.bep):'—';
    $('mProfit').textContent=jpy(mt.profit);
    $('warnCMR0').style.display=(mt.cmr<=0)?'block':'none';
  }

  function draw(mt){ (graphMode==='ball') ? drawBall(mt) : drawCVP(mt); }
  function redrawOnly(){ const mt=calc(); renderMetrics(mt); draw(mt); }

  // 並び替え（チャレンジ時は従来どおり）
  function applyOrderChallenge(){
    $('guideFixed').textContent='① （追加の）固定費はいくらですか？';
    $('guideCMR').textContent='② 限界利益率は何％ですか？';
    $('guideSales').textContent='③ 上記を元に、必要売上高を考えてみましょう';
    controls.insertBefore(challengeBox, controls.firstChild);
    controls.append(guideFixed); guideFixed.style.display='block'; controls.append(paramFixed);
    controls.append(guideCMR);   guideCMR.style.display='block';   controls.append(paramCMR);
    controls.append(guideSales); guideSales.style.display='block'; controls.append(paramSales);
    controls.append(checkRow);   checkRow.style.display='flex';
    controls.append(checkResult);
    metrics.style.display='none';
    mBEPcard.classList.remove('accent');
  }
  function applyOrderNormal(){
    guideFixed.style.display='none'; guideCMR.style.display='none'; guideSales.style.display='none';
    controls.append(paramSales); controls.append(paramCMR); controls.append(paramFixed); controls.append(challengeBox);
    controls.append(checkRow); checkRow.style.display='none';
    controls.append(checkResult); checkResult.style.display='none';
    metrics.style.display='grid';
    showTargetLine=false; targetLineValue=null; showMOSBand=false;
    mBEPcard.classList.remove('accent');
  }

  // 答え合わせ：着地同期（バウンド表示時のみアニメーション。CVP図では即時表示）
  function doCheckAnswer(){
    const mt=calc();
    const target = mt.cmr>0 ? Math.ceil(mt.fixed/mt.cmr) : Infinity;
    const diffRaw = mt.sales - target;
    const diffAbs = Math.abs(diffRaw);
    const pctV = (isFinite(target)&&target>0) ? (diffAbs/target*100) : NaN;
    let msg='差はありません';
    if(diffRaw < 0) msg = 'あと ' + jpy(diffAbs) + ' 不足しています';
    else if(diffRaw > 0) msg = 'あと ' + jpy(diffAbs) + ' 余裕があります';

    pendingVals = {
      targetText: isFinite(target)? jpy(target) : '—',
      targetNum:  isFinite(target)? target : NaN,
      msg, statusText: isFinite(pctV)? ('誤差 '+pctV.toFixed(1)+'%') : '誤差 —'
    };
    if(graphMode==='ball'){
      pendingCheck=true; if(!playing) playOnce();
    }else{
      // CVP図は即時反映
      targetShown.textContent=pendingVals.targetText;
      diffMsgEl.textContent=pendingVals.msg;
      statusEl.textContent=pendingVals.statusText;
      checkResult.style.display='block';
      metrics.style.display='grid';
      showTargetLine=true; targetLineValue=pendingVals.targetNum; // CVP側ではラベルのみ補足
      redrawOnly();
    }
  }

  // リセット
  function resetAll(){
    revealedByPlay=false; apexMarkerY=null; playing=false; resultEl.textContent=''; resultEl.classList.remove('ng');
    pendingCheck=false; pendingVals=null; checkResult.style.display='none';
    showTargetLine=false; targetLineValue=null; showMOSBand=false;
    I.sales.value=(DEFAULTS.sales).toLocaleString('ja-JP'); I.cmr.value=String(DEFAULTS.cmr); I.fixed.value=(DEFAULTS.fixed).toLocaleString('ja-JP');
    I.salesRange.value=String(DEFAULTS.sales); I.cmrRange.value=String(DEFAULTS.cmr); I.fixedRange.value=String(DEFAULTS.fixed);
    metrics.style.display = toggle.checked ? 'none' : 'grid';
    mBEPcard.classList.remove('accent');
    redrawOnly();
  }

  // プレイ（バウンド）
  function playOnce(){
    if(graphMode!=='ball'){ // CVP図モードでは即時計算＆表示のみ
      const p=calc().profit;
      if(p>0){ resultEl.classList.remove('ng'); resultEl.textContent=`黒字達成！ 経常利益 ≈ ${jpy(p)}`; }
      else if(p<0){ resultEl.classList.add('ng'); resultEl.textContent=`赤字（経常損失）… 損失 ≈ ${jpy(-p)}`; }
      else{ resultEl.classList.remove('ng'); resultEl.textContent=`損益分岐点！ ±0（トントン）`; }
      return;
    }
    if(playing) return; playing=true; resultEl.textContent=''; resultEl.classList.remove('ng');
    const mt=calc();
    const maxV=Math.max(1,mt.sales,mt.cm,mt.fixed)*1.15;
    const sH=sy(mt.sales,maxV), tH=sy(mt.cm,maxV);
    const r=(window.innerWidth<820)?8:9;
    let y=dims.GROUND_Y - sH, vy=0, g=.6, prevVy=0, bounced=false, ground=dims.GROUND_Y - r; apexMarkerY=null;
    const ball=()=>{ ctx.beginPath(); ctx.fillStyle='#475569'; ctx.arc(dims.W/2,y,r,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='#94a3b8'; ctx.stroke(); };

    function frame(){
      prevVy=vy; vy+=g; y+=vy;
      if(y>=ground && !bounced){
        y=ground; const apex=dims.GROUND_Y - tH - r; const rise=y - apex;
        vy = -Math.sqrt(Math.max(0,2*g*rise)); bounced=true;
      }else if(bounced){
        if(prevVy<0 && vy>=0 && apexMarkerY==null){ apexMarkerY=y; }
        if(vy>0 && y>=ground){
          revealedByPlay=true; redrawOnly(); ball();
          const p=calc().profit;
          if(p>0){ resultEl.classList.remove('ng'); resultEl.textContent=`黒字達成！ 経常利益 ≈ ${jpy(p)}`; }
          else if(p<0){ const c=calc(); resultEl.classList.add('ng'); resultEl.textContent=`赤字（経常損失）… 損失 ≈ ${jpy(-p)} ／ あと ≈ ${jpy(Math.max(0, c.fixed - c.cm))} の限界利益が必要`; }
          else{ resultEl.classList.remove('ng'); resultEl.textContent=`損益分岐点！ ±0（トントン）`; }

          if(pendingCheck && pendingVals){
            targetShown.textContent = pendingVals.targetText;
            diffMsgEl.textContent   = pendingVals.msg;
            statusEl.textContent    = pendingVals.statusText;
            checkResult.style.display='block';
            metrics.style.display='grid';
            showTargetLine = isFinite(pendingVals.targetNum);
            targetLineValue = pendingVals.targetNum;
            showMOSBand = showTargetLine;
            mBEPcard.classList.add('accent');
            pendingCheck=false; pendingVals=null;
            redrawOnly();
          }
          playing=false; return;
        }
      }
      redrawOnly(); ball(); requestAnimationFrame(frame);
    }
    requestAnimationFrame(frame);
  }

  // 入力連動
  function clearCheckVisuals(){
    checkResult.style.display='none';
    metrics.style.display = toggle.checked ? 'none' : 'grid';
    showTargetLine=false; targetLineValue=null; showMOSBand=false;
    pendingCheck=false; pendingVals=null; mBEPcard.classList.remove('accent');
  }
  function linkCurrency(t, r, hardMax=null){
    const toR=()=>{ const v=Number(String(t.value).replace(/[^\d.-]/g,'')||0);
      if(hardMax && v>hardMax) r.max=hardMax; else if(v>Number(r.max)) r.max=v;
      r.value=String(v); if(toggle.checked){ clearCheckVisuals(); }
      revealedByPlay=false; apexMarkerY=null; resultEl.textContent=''; redrawOnly();
    };
    const toN=()=>{ const v=Number(r.value||0); t.value=isFinite(v)?Math.round(v).toLocaleString('ja-JP'):''; 
      if(toggle.checked){ clearCheckVisuals(); }
      revealedByPlay=false; apexMarkerY=null; resultEl.textContent=''; redrawOnly();
    };
    t.addEventListener('input',toR); t.addEventListener('change',toR); t.addEventListener('blur',toR);
    r.addEventListener('input',toN); r.addEventListener('change',toN);
  }
  function linkNumber(n,r){
    const toR=()=>{ const v=Number(n.value||0); if(v>Number(r.max)) r.max=v; r.value=String(v);
      if(toggle.checked){ clearCheckVisuals(); }
      revealedByPlay=false; apexMarkerY=null; resultEl.textContent=''; redrawOnly(); };
    const toN=()=>{ n.value=r.value;
      if(toggle.checked){ clearCheckVisuals(); }
      revealedByPlay=false; apexMarkerY=null; resultEl.textContent=''; redrawOnly(); };
    n.addEventListener('input',toR); n.addEventListener('change',toR);
    r.addEventListener('input',toN); r.addEventListener('change',toN);
  }
  linkCurrency(I.sales,I.salesRange,5000000);
  linkNumber(I.cmr,I.cmrRange);
  linkCurrency(I.fixed,I.fixedRange,2000000);

  // チャレンジ切替
  $('challengeToggle').addEventListener('change', ()=>{
    if(toggle.checked){ applyOrderChallenge(); } else { applyOrderNormal(); }
    revealedByPlay=false; apexMarkerY=null; resultEl.textContent='';
    clearCheckVisuals(); redrawOnly();
  });

  // モード切替
  modeBall.addEventListener('click',()=>{
    graphMode='ball'; modeBall.classList.add('active'); modeCVP.classList.remove('active');
    resultEl.textContent=''; revealedByPlay=false; apexMarkerY=null; redrawOnly();
  });
  modeCVP.addEventListener('click',()=>{
    graphMode='cvp'; modeCVP.classList.add('active'); modeBall.classList.remove('active');
    // CVP図では「???」の隠しを使わない（見せて理解させる）
    resultEl.textContent=''; redrawOnly();
  });

  // ボタン
  $('play').addEventListener('click', ()=>playOnce());
  $('reset').addEventListener('click', resetAll);
  $('reset2').addEventListener('click', resetAll);
  $('checkBtn').addEventListener('click', ()=>doCheckAnswer());

  // レイアウト
  function layout(){ computeDims(); setupCanvas(); redrawOnly(); }
  if('ResizeObserver' in window){ new ResizeObserver(layout).observe(cv.parentElement); }
  ['load','pageshow','orientationchange','resize'].forEach(ev=>addEventListener(ev,()=>requestAnimationFrame(layout)));

  // 初期化
  (function init(){
    I.sales.value=(DEFAULTS.sales).toLocaleString('ja-JP');
    I.fixed.value=(DEFAULTS.fixed).toLocaleString('ja-JP');
    I.cmr.value=String(DEFAULTS.cmr);
    applyOrderNormal();
    layout();
  })();
})();
</script>
</body>
</html>