<!DOCTYPE html>
<!-- internal version: r38 -->
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>ボールで学ぶ変動損益計算書（完全版）</title>
<style>
:root{ --brand:#578899; --brand-600:#4b7481; --ink:#0f172a; --bg:#fff; --panel:#fff;
  --muted:#64748b; --line:#e5e7eb; --line-dark:#cbd5e1; --side-pad:16px; --danger:#b91c1c;}
*{box-sizing:border-box}
html,body{ margin:0; height:100%; width:100%; position:fixed; inset:0; overflow:hidden;
  -webkit-text-size-adjust:100%; -webkit-tap-highlight-color:transparent;
  background:var(--bg); color:var(--ink);
  font:16px/1.6 -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic UI","Yu Gothic",Meiryo,sans-serif;}
.page{ position:fixed; inset:0;
  padding:16px calc(var(--side-pad) + env(safe-area-inset-right))
           calc(16px + env(safe-area-inset-bottom))
           calc(var(--side-pad) + env(safe-area-inset-left));
  overflow-y:auto; overflow-x:hidden; -webkit-overflow-scrolling:touch; touch-action:pan-y; overscroll-behavior:contain;}
.stack{display:block; width:100%; max-width:1120px; margin:0 auto;}
.grid-main{ display:grid; grid-template-columns:1fr; gap:16px; align-items:start; }
@media (min-width:960px){ .grid-main{ grid-template-columns:1.1fr 0.9fr; } }
.card{ background:var(--panel); border:1px solid var(--line); border-radius:16px; box-shadow:0 6px 16px rgba(0,0,0,.06); padding:12px; overflow:hidden; }
h1{font-size:18px;margin:0 0 8px}
.note-top{ background:#eef7fa; border:1px solid #d6e7ee; color:#0b3c4a; padding:6px 8px; border-radius:12px; margin:6px 0 10px; font-size:13px; }
.controls{display:grid; gap:8px}
label.f{ display:block; background:#fafafa; border:1px solid var(--line); border-radius:12px; padding:6px 8px; min-width:0;}
.f .row1{display:flex; align-items:center; justify-content:space-between; gap:8px}
.f .row1 .ttl{font-weight:600; white-space:nowrap; flex:1 1 auto;}
.f .row2{margin-top:6px}

input,button,label{font-size:16px; line-height:1.3}
input[type="number"], input[type="text"]{ width:96px; max-width:38vw; background:#fff; border:1px solid var(--line-dark);
  border-radius:8px; padding:8px 8px; text-align:right; }

/* range */
input[type="range"]{ appearance:none; width:100%; height:28px; background:transparent; border:0; outline:none;}
input[type="range"]::-webkit-slider-runnable-track{ height:8px; border-radius:999px; background:var(--line); }
input[type="range"]::-moz-range-track{ height:8px; border-radius:999px; background:var(--line); }
input[type="range"]::-webkit-slider-thumb{ appearance:none; width:20px; height:20px; border-radius:50%;
  background:var(--brand); border:2px solid #fff; box-shadow:0 1px 4px rgba(0,0,0,.2); margin-top:-6px;}
input[type="range"]::-moz-range-thumb{ width:20px; height:20px; border-radius:50%; background:var(--brand);
  border:2px solid #fff; box-shadow:0 1px 4px rgba(0,0,0,.2); }

/* buttons */
.btns{display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; margin-bottom:0;}
button{appearance:none; border:0; border-radius:12px; padding:12px 16px; font-weight:700; cursor:pointer}
.primary{background:var(--brand); color:#fff} .primary:active{background:var(--brand-600)}
.secondary{background:#fff; color:#0f172a; border:1px solid var(--line-dark)}
.small{padding:8px 12px; font-weight:600; border-radius:10px}
.btn-compact{ padding:8px 12px; font-size:14px; line-height:1.2; border-radius:10px; }
canvas{ width:100%; max-width:100%; height:auto; display:block; border-radius:12px; border:1px solid var(--line); background:#fff }
.muted{color:#64748b; font-size:12px; margin-top:6px}
.result{font-size:16px; font-weight:700; margin-top:4px}
.result.ng{ color:var(--danger); }

.metrics{display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:10px}
.m{background:#fafafa; border:1px solid var(--line); border-radius:12px; padding:10px}
.m .k{color:#334155; font-size:12px} .m .v{font-weight:700; margin-top:4px}
.m.em{outline:1px solid rgba(87,136,153,.35); background:rgba(87,136,153,.06)}
.challenge{margin-top:0;border:1px dashed var(--line-dark);padding:10px;border-radius:12px;background:#fbfdfe}
.challenge .row{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:6px}
.status{font-weight:700}
.guide{color:#334155; font-size:14px; margin:2px 4px -2px; padding-left:2px; font-weight:700;}
.footer{display:flex;justify-content:center;opacity:.95;margin:12px 0 2px;color:#334155;font-size:12px;text-align:center}
.footer small{white-space:normal;line-height:1.5}
@media (max-width:480px){ input[type="number"],input[type="text"]{width:36vw} }
</style>
</head>
<body>
<div class="page">
  <div class="stack">
    <div class="grid-main">
      <!-- 左：グラフ -->
      <div class="card" id="cardGraph">
        <h1>ボールで学ぶ変動損益計算書</h1>
        <div class="note-top">
          ・固定費：越えるべきハードルの高さ<br>
          ・売上高：ボールを落とす高さ<br>
          ・限界利益：バウンドした頂点<br>
          バウンド頂点（<span id="labelTop">限界利益</span>）がハードル（固定費）を越えれば黒字です。
        </div>
        <canvas id="cv" width="860" height="420" aria-label="学習キャンバス"></canvas>
        <div class="btns">
          <button id="play" class="primary btn-compact" type="button">黒字かどうか確認</button>
          <button id="reset" class="secondary btn-compact" type="button">リセット</button>
        </div>
        <div id="result" class="result" aria-live="polite"></div>
      </div>

      <!-- 右：パラメータ -->
      <div class="card" id="cardCtrl">
        <div class="controls" id="controls">
          <label class="f" id="paramSales">
            <div class="row1"><span class="ttl">売上高（S）</span><input id="sales" type="text" inputmode="numeric" pattern="[0-9,]*" value="1,300,000"></div>
            <div class="row2"><input id="salesRange" type="range" min="0" max="5000000" step="1000" value="1300000"></div>
          </label>

          <label class="f" id="paramCMR">
            <div class="row1"><span class="ttl">限界利益率（CMR, %）</span><input id="cmr" type="number" inputmode="decimal" min="0" max="100" step="0.1" value="60"></div>
            <div class="row2"><input id="cmrRange" type="range" min="0" max="100" step="0.1" value="60"></div>
          </label>

          <label class="f" id="paramFixed">
            <div class="row1"><span class="ttl">固定費（FC）</span><input id="fixed" type="text" inputmode="numeric" pattern="[0-9,]*" value="1,000,000"></div>
            <div class="row2"><input id="fixedRange" type="range" min="0" max="2000000" step="1000" value="1000000"></div>
          </label>

          <!-- チャレンジ：固定費の直下に配置 -->
          <div class="challenge" id="challengeBox">
            <label><input type="checkbox" id="challengeToggle"> 必要売上高を考えてみましょう</label>
            <div id="guideFixed" class="guide" style="display:none">① まずは固定費を設定しましょう</div>
            <div id="guideCMR" class="guide" style="display:none">② 次に、限界利益率を設定しましょう</div>
            <div id="guideSales" class="guide" style="display:none">③ 必要売上高を考えてみましょう</div>
            <div class="row" id="checkRow" style="display:none">
              <button id="checkBtn" class="primary btn-compact" type="button">答え合わせ</button>
              <button id="reset2" class="secondary btn-compact" type="button">リセット</button>
            </div>
            <div id="checkResult" style="display:none; margin-top:6px">
              <div>必要売上高：<span id="targetShown">—</span></div>
              <div>いまの売上高との差：<span id="diff">—</span>／判定：<span id="status" class="status">—</span></div>
              <div class="muted">±1%以内で<strong>クリア</strong>, ±5%以内は<strong>ニア</strong>。</div>
            </div>
          </div>

          <div id="warnCMR0" class="muted" style="display:none;color:#8b5e00">※ 限界利益率が0%のため、どれだけ売上高があっても黒字になりません。</div>
        </div>

        <div class="metrics" id="metrics">
          <div class="m"><div class="k">売上高 (S)</div><div id="mSales" class="v">-</div></div>
          <div class="m"><div class="k">限界利益率 (CMR)</div><div id="mCMR" class="v">-</div></div>
          <div class="m em"><div class="k">限界利益 (S×CMR)</div><div id="mCM" class="v">-</div></div>
          <div class="m"><div class="k">損益分岐点売上高 (FC÷CMR)</div><div id="mBEP" class="v">-</div></div>
          <div class="m em"><div class="k">経常利益 ≒ 限界利益−固定費</div><div id="mProfit" class="v">-</div></div>
        </div>
      </div>
    </div>

    <div class="footer"><small>Copyright (c) 2025 税理士法人松本会計事務所 All Rights Reserved.</small></div>
  </div>
</div>

<script>
(function(){
  const DEFAULTS={sales:1300000, cmr:60, fixed:1000000};

  const $=id=>document.getElementById(id);
  document.addEventListener('touchmove',(e)=>{ if(e.touches && e.touches.length>1){ e.preventDefault(); } },{passive:false});

  const cv=$('cv'); const ctx=cv.getContext('2d');

  const I={ sales:$('sales'), cmr:$('cmr'), fixed:$('fixed'),
            salesRange:$('salesRange'), cmrRange:$('cmrRange'), fixedRange:$('fixedRange') };
  const playBtn=$('play'), resetBtn=$('reset'), resultEl=$('result'), labelTop=$('labelTop');
  const mSales=$('mSales'), mCMR=$('mCMR'), mCM=$('mCM'), mBEP=$('mBEP'), mProfit=$('mProfit');
  const toggle=$('challengeToggle'), metrics=$('metrics');
  const controls=$('controls'); const paramSales=$('paramSales'), paramCMR=$('paramCMR'), paramFixed=$('paramFixed');
  const guideFixed=$('guideFixed'), guideCMR=$('guideCMR'), guideSales=$('guideSales');
  const checkRow=$('checkRow'), checkBtn=$('checkBtn'), checkResult=$('checkResult'), reset2=$('reset2');
  const targetShown=$('targetShown'), diffEl=$('diff'), statusEl=$('status');

  const parseComma=v=>Number(String(v??'').replace(/[^\d.-]/g,'')||0);
  const num=el=> (el===I.sales||el===I.fixed)? parseComma(el.value) : Number(el.value||0);
  const jpy=v=>isFinite(v)?v.toLocaleString('ja-JP',{style:'currency',currency:'JPY',maximumFractionDigits:0}):'—';
  const brand=()=>getComputedStyle(document.documentElement).getPropertyValue('--brand').trim()||'#578899';

  let dpr=1, revealedByPlay=false, playing=false, apexMarkerY=null;
  const dims={W:360,H:240,MARGIN:36,GROUND_Y:204};
  const sy=(v,maxV)=>(dims.H - dims.MARGIN*2) * (v / maxV);

  function computeDims(){
    const rect=cv.parentElement.getBoundingClientRect();
    const w=Math.max(300,Math.min(640,Math.floor(rect.width)));
    const h=Math.max(240,Math.round(w*0.66));
    dims.W=w; dims.H=h; dims.MARGIN=36; dims.GROUND_Y=h-36;
  }
  function setupCanvas(){
    dpr=Math.max(1,window.devicePixelRatio||1);
    cv.width=Math.round(dims.W*dpr); cv.height=Math.round(dims.H*dpr);
    cv.style.width=dims.W+'px'; cv.style.height=dims.H+'px';
    ctx.setTransform(1,0,0,1,0,0); ctx.scale(dpr,dpr);
  }

  function calc(){
    const sales=Math.max(0,num(I.sales));
    const cmrPct=Math.max(0,Math.min(100,num(I.cmr)));
    const fixed=Math.max(0,num(I.fixed));
    const cmr=cmrPct/100, cm=sales*cmr, profit=cm-fixed, bep=cmr>0?Math.ceil(fixed/cmr):Infinity;
    return {sales,cmrPct,cmr,cm,profit,bep,fixed};
  }

  function arrow(x1,y1,x2,y2,c){
    ctx.strokeStyle=c; ctx.fillStyle=c; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
    const a=Math.atan2(y2-y1,x2-x1),h=8;
    ctx.beginPath(); ctx.moveTo(x2,y2);
    ctx.lineTo(x2-h*Math.cos(a-Math.PI/6), y2-h*Math.sin(a-Math.PI/6));
    ctx.lineTo(x2-h*Math.cos(a+Math.PI/6), y2-h*Math.sin(a+Math.PI/6));
    ctx.closePath(); ctx.fill();
  }
  function dblArrowV(x,yTop,yBot,c){
    ctx.strokeStyle=c; ctx.fillStyle=c; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(x,yTop); ctx.lineTo(x,yBot); ctx.stroke();
    const h=8;
    ctx.beginPath(); ctx.moveTo(x,yTop);
    ctx.lineTo(x-h*Math.cos(Math.PI/6), yTop+h*Math.sin(Math.PI/6));
    ctx.lineTo(x+h*Math.cos(Math.PI/6), yTop+h*Math.sin(Math.PI/6));
    ctx.closePath(); ctx.fill();
    ctx.beginPath(); ctx.moveTo(x,yBot);
    ctx.lineTo(x-h*Math.cos(Math.PI/6), yBot-h*Math.sin(Math.PI/6));
    ctx.lineTo(x+h*Math.cos(Math.PI/6), yBot-h*Math.sin(Math.PI/6));
    ctx.closePath(); ctx.fill();
  }

  function draw(mt){
    const maxV=Math.max(1,mt.sales,mt.cm,mt.fixed)*1.15;
    const hide=toggle.checked && !revealedByPlay;

    ctx.clearRect(0,0,dims.W,dims.H);
    ctx.fillStyle='#fff'; ctx.fillRect(0,0,dims.W,dims.H);
    ctx.font='12px system-ui,-apple-system,Segoe UI,Roboto,sans-serif';

    // 地面
    ctx.fillStyle='#e2e8f0'; ctx.fillRect(0,dims.GROUND_Y,dims.W,3);

    // 目盛り
    ctx.strokeStyle='#e5e7eb'; ctx.lineWidth=1; ctx.setLineDash([4,4]);
    ctx.fillStyle='#475569';
    for(let i=0;i<=5;i++){
      const val=(maxV/5)*i, h=sy(val,maxV), y=dims.GROUND_Y-h;
      ctx.beginPath(); ctx.moveTo(dims.MARGIN,y); ctx.lineTo(dims.W-dims.MARGIN,y); ctx.stroke();
      ctx.fillText(jpy(val), 6, y-2);
    }
    ctx.setLineDash([]);

    // 固定費：矩形（端末幅に応じてやや狭く）
    const BR=brand();
    const pad = Math.max(12, Math.round(dims.W * 0.08));
    const barW = Math.max(160, Math.min(400, dims.W - pad*2));
    const barL = Math.round((dims.W - barW)/2);
    const hH=sy(mt.fixed,maxV), hY=dims.GROUND_Y-hH;
    const hHgt = Math.max(0, dims.GROUND_Y - hY);
    ctx.fillStyle='rgba(87,136,153,0.15)'; ctx.fillRect(barL, hY, barW, hHgt);
    ctx.strokeStyle=BR; ctx.lineWidth=2; ctx.strokeRect(barL, hY, barW, hHgt);
    ctx.fillStyle=BR; ctx.fillText('固定費（ハードル）: '+jpy(mt.fixed), Math.max(6,barL), hY-8);

    // 売上ラベル＋点線
    const xSalesArrow = dims.W - dims.MARGIN - 18;
    const xCMArrow    = xSalesArrow - 28;
    const sH=sy(mt.sales,maxV), sY=dims.GROUND_Y-sH;
    ctx.save(); ctx.setLineDash([3,4]); ctx.strokeStyle='#475569';
    ctx.beginPath(); ctx.moveTo(dims.MARGIN, sY); ctx.lineTo(xSalesArrow-2, sY); ctx.stroke(); ctx.restore();
    const tSales='売上高: '+(hide?'???':jpy(mt.sales));
    const ySales=sY - 6;
    if(hide){ ctx.save(); ctx.fillStyle='#475569'; ctx.textAlign='right'; ctx.fillText(tSales, xCMArrow-6, ySales); ctx.restore(); }
    else{ ctx.save(); ctx.fillStyle='#475569'; ctx.textAlign='right'; ctx.fillText(tSales, dims.W-6, ySales); ctx.restore(); }
    arrow(xSalesArrow, sY, xSalesArrow, dims.GROUND_Y-3, BR);

    // 限界利益
    const b=mt.cm, bH=sy(b,maxV), bY=dims.GROUND_Y-bH;
    if(!hide){
      ctx.save(); ctx.setLineDash([3,4]); ctx.strokeStyle='#0ea5e9';
      ctx.beginPath(); ctx.moveTo(dims.MARGIN, bY); ctx.lineTo(xCMArrow-2, bY); ctx.stroke(); ctx.restore();
      ctx.fillStyle='#0ea5e9';
      const tCM='限界利益: '+jpy(b);
      const w=ctx.measureText(tCM).width;
      const xText = Math.min(dims.W-dims.MARGIN-w, xCMArrow+8);
      ctx.fillText(tCM, xText, bY-6);
      arrow(xCMArrow, dims.GROUND_Y-3, xCMArrow, bY, BR);
    }else{
      ctx.save(); ctx.fillStyle='#0ea5e9'; ctx.textAlign='right'; ctx.fillText('限界利益: ???', xCMArrow-6, ySales+16); ctx.restore();
    }

    // 限界利益率
    const xMid=(xSalesArrow+xCMArrow)/2;
    ctx.fillStyle='#334155'; ctx.textAlign='center';
    ctx.fillText('限界利益率 ' + mt.cmrPct.toFixed(1) + '%', xMid, dims.H-10);
    ctx.textAlign='start';

    // 待機ボール
    const rBall=9;
    if(!playing){
      const y0=dims.GROUND_Y - sH;
      ctx.beginPath(); ctx.fillStyle='#475569'; ctx.arc(dims.W/2,y0,rBall,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='#94a3b8'; ctx.stroke();
    }

    // 残像
    if(apexMarkerY!=null){
      ctx.save(); ctx.globalAlpha=.5; ctx.strokeStyle='#94a3b8'; ctx.lineWidth=2;
      ctx.beginPath(); ctx.arc(dims.W/2,apexMarkerY,10,0,Math.PI*2); ctx.stroke(); ctx.restore();
    }

    // プレイ後：差分矢印＋黒字/赤字
    if(revealedByPlay){
      const bH2=sy(mt.cm,maxV), bY2=dims.GROUND_Y-bH2;
      const hH2=sy(mt.fixed,maxV), hY2=dims.GROUND_Y-hH2;
      const yTop = Math.min(bY2, hY2), yBot = Math.max(bY2, hY2);
      const xNearBall = Math.min(dims.W - dims.MARGIN - 24, (dims.W/2) + rBall + 10);
      const p = mt.cm - mt.fixed;
      const isProfit = p > 0, isLoss = p < 0;
      const color = isProfit ? BR : (isLoss ? (getComputedStyle(document.documentElement).getPropertyValue('--danger').trim() || '#b91c1c') : '#334155');
      dblArrowV(xNearBall, yTop, yBot, color);
      let txt = isProfit ? ('黒字 ' + jpy(p)) : isLoss ? ('赤字 ' + jpy(-p)) : '±0';
      ctx.save(); ctx.fillStyle=color; ctx.font='bold 12px system-ui,-apple-system,Segoe UI,Roboto,sans-serif';
      ctx.textBaseline='middle';
      const wlbl=ctx.measureText(txt).width;
      ctx.fillText(txt, Math.min(dims.W-6-wlbl, xNearBall+10), (yTop+yBot)/2);
      ctx.restore();
    }
  }

  // サマリー表示
  function renderMetrics(mt){
    mSales.textContent=jpy(mt.sales);
    mCMR.textContent=mt.cmrPct.toFixed(1)+'%';
    mCM.textContent=jpy(mt.cm);
    mBEP.textContent=isFinite(mt.bep)? jpy(mt.bep) : '—';
    mProfit.textContent=jpy(mt.profit);
    $('warnCMR0').style.display=(mt.cmr<=0)?'block':'none';
  }
  function redrawOnly(){ const mt=calc(); renderMetrics(mt); draw(mt); labelTop.textContent='限界利益'; }

  // 並べ替え＆表示制御（チャレンジON：固定費→CMR→売上高）
  function reorderParameters(isChallenge){
    if(isChallenge){
      controls.append(paramFixed, paramCMR, paramSales);
      controls.insertBefore($('challengeBox'), paramCMR); // 固定費の直下にチャレンジ
      guideFixed.style.display='block'; guideCMR.style.display='block'; guideSales.style.display='block';
      checkRow.style.display='flex';
      metrics.style.display='none';       // 答え合わせ前は隠す
    }else{
      guideFixed.style.display='none'; guideCMR.style.display='none'; guideSales.style.display='none';
      checkRow.style.display='none'; checkResult.style.display='none';
      controls.append(paramSales, paramCMR, paramFixed);
      controls.append($('challengeBox')); // 通常は固定費の下にそのまま
      metrics.style.display='grid';
    }
  }

  // 「答え合わせ」：結果表示＋プレイ動作
  function doCheckAnswer(){
    const mt=calc();
    const target = mt.cmr>0 ? Math.ceil(mt.fixed/mt.cmr) : Infinity;
    targetShown.textContent = isFinite(target)? jpy(target) : '—';
    const diff = mt.sales - target;
    diffEl.textContent = isFinite(diff)? (diff>=0?'+':'')+jpy(diff) : '—';
    const pct=(isFinite(target)&&target>0)?Math.abs(diff)/target:Infinity;
    const st=(isFinite(pct)&&pct<=0.01)?'クリア！':(isFinite(pct)&&pct<=0.05)?'ニア':'未達';
    statusEl.textContent = isFinite(pct)? st : '—';
    checkResult.style.display='block';
    metrics.style.display='grid';     // メトリクスを表示
    if(!playing) playOnce();          // 同じ挙動（バウンド）を実行
  }

  // 共通リセット
  function resetAll(){
    revealedByPlay=false; apexMarkerY=null; playing=false; resultEl.textContent=''; resultEl.classList.remove('ng');
    I.sales.value=(DEFAULTS.sales).toLocaleString('ja-JP'); I.cmr.value=String(DEFAULTS.cmr); I.fixed.value=(DEFAULTS.fixed).toLocaleString('ja-JP');
    I.salesRange.value=String(DEFAULTS.sales); I.cmrRange.value=String(DEFAULTS.cmr); I.fixedRange.value=String(DEFAULTS.fixed);
    checkResult.style.display='none';
    metrics.style.display = toggle.checked ? 'none' : 'grid';
    redrawOnly();
  }

  // プレイ（バウンド）
  function playOnce(){
    if(playing) return; playing=true; resultEl.textContent=''; resultEl.classList.remove('ng');
    const mt=calc(); const maxV=Math.max(1, mt.sales, mt.cm, mt.fixed)*1.15;
    const sH=sy(mt.sales,maxV), tH=sy(mt.cm,maxV);
    const r=9; let y=dims.GROUND_Y - sH, vy=0, g=.6, prevVy=0, bounced=false, ground=dims.GROUND_Y - r; apexMarkerY=null;
    const ball=()=>{ ctx.beginPath(); ctx.fillStyle='#475569'; ctx.arc(dims.W/2,y,r,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='#94a3b8'; ctx.stroke(); };
    function frame(){
      prevVy=vy; vy+=g; y+=vy;
      if(y>=ground && !bounced){
        y=ground; const apex=dims.GROUND_Y - tH - r; const rise=y - apex;
        vy = -Math.sqrt(Math.max(0,2*g*rise)); bounced=true;
      }else if(bounced){
        if(prevVy<0 && vy>=0 && apexMarkerY==null){ apexMarkerY=y; }
        if(vy>0 && y>=ground){
          revealedByPlay=true; redrawOnly(); ball();
          const p=calc().profit;
          if(p>0){ resultEl.classList.remove('ng'); resultEl.textContent=`黒字達成！ 経常利益 ≈ ${jpy(p)}`; }
          else if(p<0){ const c=calc(); resultEl.classList.add('ng'); resultEl.textContent=`赤字（経常損失）… 損失 ≈ ${jpy(-p)} ／ あと ≈ ${jpy(Math.max(0, c.fixed - c.cm))} の限界利益が必要`; }
          else{ resultEl.classList.remove('ng'); resultEl.textContent=`損益分岐点！ ±0（トントン）`; }
          playing=false; return;
        }
      }
      redrawOnly(); ball(); requestAnimationFrame(frame);
    }
    requestAnimationFrame(frame);
  }

  // 入力リンク（変更時は結果/メトリクス非表示に）
  function linkCurrency(textInput, range, {maxGrow=true, hardMax=null}={}){
    const toR=()=>{ const v=Number(String(textInput.value??'').replace(/[^\d.-]/g,'')||0);
      if(maxGrow){ const m=Number(range.max||0); if(v>m){ range.max = hardMax?Math.min(v,hardMax):v; } }
      range.value=String(v);
      if(toggle.checked){ checkResult.style.display='none'; metrics.style.display='none'; }
      revealedByPlay=false; apexMarkerY=null; resultEl.textContent=''; resultEl.classList.remove('ng'); redrawOnly();
    };
    const toN=()=>{ const v=Number(range.value||0);
      textInput.value = (isFinite(v)? Math.round(v).toLocaleString('ja-JP') : '');
      if(toggle.checked){ checkResult.style.display='none'; metrics.style.display='none'; }
      revealedByPlay=false; apexMarkerY=null; resultEl.textContent=''; resultEl.classList.remove('ng'); redrawOnly();
    };
    textInput.addEventListener('input', toR); textInput.addEventListener('change', toR); textInput.addEventListener('blur', toR);
    range.addEventListener('input', toN); range.addEventListener('change', toN);
  }
  function linkNumber(n,r,{maxGrow=true}={}){
    const toR=()=>{ const v=Number(n.value||0); if(maxGrow){const m=Number(r.max||0); if(v>m){r.max=v;}} r.value=String(v);
      if(toggle.checked){ checkResult.style.display='none'; metrics.style.display='none'; }
      revealedByPlay=false; apexMarkerY=null; resultEl.textContent=''; resultEl.classList.remove('ng'); redrawOnly(); };
    const toN=()=>{ n.value=r.value;
      if(toggle.checked){ checkResult.style.display='none'; metrics.style.display='none'; }
      revealedByPlay=false; apexMarkerY=null; resultEl.textContent=''; resultEl.classList.remove('ng'); redrawOnly(); };
    n.addEventListener('input',toR); n.addEventListener('change',toR); r.addEventListener('input',toN); r.addEventListener('change',toN);
  }

  linkCurrency(I.sales,I.salesRange,{hardMax:5000000});
  linkNumber(I.cmr,I.cmrRange,{maxGrow:false});
  linkCurrency(I.fixed,I.fixedRange,{hardMax:2000000});

  // ボタン
  playBtn.addEventListener('click', ()=> playOnce() );
  resetBtn.addEventListener('click', resetAll);
  reset2.addEventListener('click', resetAll);
  checkBtn.addEventListener('click', ()=> doCheckAnswer() );

  // チャレンジ切替
  toggle.addEventListener('change', ()=>{
    reorderParameters(toggle.checked);
    checkResult.style.display='none';
    revealedByPlay=false; apexMarkerY=null; resultEl.textContent=''; resultEl.classList.remove('ng');
    redrawOnly();
  });

  // レイアウト監視
  function layoutAndRedraw(){ computeDims(); setupCanvas(); redrawOnly(); }
  if('ResizeObserver' in window){ new ResizeObserver(layoutAndRedraw).observe(cv.parentElement); }
  ['DOMContentLoaded','load','pageshow','orientationchange','resize'].forEach(ev=>window.addEventListener(ev,()=>requestAnimationFrame(layoutAndRedraw)));

  // 初期化
  (function init(){
    I.sales.value=(DEFAULTS.sales).toLocaleString('ja-JP');
    I.fixed.value=(DEFAULTS.fixed).toLocaleString('ja-JP');
    I.cmr.value=String(DEFAULTS.cmr);
    // 通常順：売上→CMR→固定費、チャレンジは固定費の直下に配置されるが常に固定費の下に保持
    controls.append(paramSales, paramCMR, paramFixed);
    controls.append($('challengeBox'));
  })();
  setTimeout(layoutAndRedraw, 60);
})();
</script>
</body>
</html>
